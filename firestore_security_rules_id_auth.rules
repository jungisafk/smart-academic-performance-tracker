rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user role
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'ADMIN';
    }
    
    // Helper function to check if user is teacher
    function isTeacher() {
      return isAuthenticated() && getUserRole() == 'TEACHER';
    }
    
    // Helper function to check if user is student
    function isStudent() {
      return isAuthenticated() && getUserRole() == 'STUDENT';
    }
    
    // ==================== PRE-REGISTERED STUDENTS ====================
    // Only admins can manage pre-registered students
    match /pre_registered_students/{docId} {
      // Admins can read all pre-registered students
      allow read: if isAdmin();
      
      // Admins can create new pre-registered students
      allow create: if isAdmin() && 
                      request.resource.data.studentId is string &&
                      request.resource.data.firstName is string &&
                      request.resource.data.lastName is string &&
                      request.resource.data.courseId is string &&
                      request.resource.data.yearLevelId is string &&
                      request.resource.data.createdBy == request.auth.uid;
      
      // Admins can update pre-registered students
      allow update: if isAdmin() &&
                      request.resource.data.studentId == resource.data.studentId; // Cannot change student ID
      
      // Admins can delete pre-registered students
      allow delete: if isAdmin();
    }
    
    // ==================== PRE-REGISTERED TEACHERS ====================
    // Only admins can manage pre-registered teachers
    match /pre_registered_teachers/{docId} {
      // Admins can read all pre-registered teachers
      allow read: if isAdmin();
      
      // Admins can create new pre-registered teachers
      allow create: if isAdmin() && 
                      request.resource.data.teacherId is string &&
                      request.resource.data.firstName is string &&
                      request.resource.data.lastName is string &&
                      request.resource.data.departmentCourseId is string &&
                      request.resource.data.createdBy == request.auth.uid;
      
      // Admins can update pre-registered teachers
      allow update: if isAdmin() &&
                      request.resource.data.teacherId == resource.data.teacherId; // Cannot change teacher ID
      
      // Admins can delete pre-registered teachers
      allow delete: if isAdmin();
    }
    
    // ==================== USERS COLLECTION ====================
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isAuthenticated() && 
                    (request.auth.uid == userId || isAdmin());
      
      // Users can be created during account activation
      allow create: if isAuthenticated() && 
                      request.auth.uid == userId &&
                      (request.resource.data.role == 'STUDENT' || 
                       request.resource.data.role == 'TEACHER' ||
                       request.resource.data.role == 'ADMIN');
      
      // Users can update their own profile (limited fields)
      // Admins can update any user profile
      allow update: if isAuthenticated() && (
                      (request.auth.uid == userId && 
                       request.resource.data.role == resource.data.role && // Cannot change own role
                       request.resource.data.studentId == resource.data.studentId && // Cannot change IDs
                       request.resource.data.teacherId == resource.data.teacherId) ||
                      isAdmin()
                    );
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // ==================== LOGIN ATTEMPTS ====================
    // For rate limiting and security
    match /login_attempts/{userId} {
      // Anyone can read/write their own login attempts (for rate limiting)
      allow read, write: if true; // Public read/write for rate limiting functionality
      
      // Admins can view all login attempts
      allow read: if isAdmin();
      
      // Admins can clear login attempts (unlock accounts)
      allow delete: if isAdmin();
    }
    
    // ==================== COURSES ====================
    match /courses/{courseId} {
      // Everyone can read courses
      allow read: if true;
      
      // Only admins can manage courses
      allow create, update, delete: if isAdmin();
    }
    
    // ==================== YEAR LEVELS ====================
    match /year_levels/{yearLevelId} {
      // Everyone can read year levels
      allow read: if true;
      
      // Only admins can manage year levels
      allow create, update, delete: if isAdmin();
    }
    
    // ==================== SUBJECTS ====================
    match /subjects/{subjectId} {
      // Students can read subjects for their course/year level
      allow read: if isAuthenticated();
      
      // Teachers can read subjects in their department or minor subjects
      allow read: if isTeacher();
      
      // Admins can read all subjects
      allow read: if isAdmin();
      
      // Only admins can create, update, or delete subjects
      allow create, update, delete: if isAdmin();
    }
    
    // ==================== STUDENT ENROLLMENTS ====================
    match /student_enrollments/{enrollmentId} {
      // Students can read their own enrollments
      allow read: if isStudent() && 
                    resource.data.studentId == request.auth.uid;
      
      // Teachers can read enrollments for their subjects
      allow read: if isTeacher() && 
                    resource.data.teacherId == request.auth.uid;
      
      // Admins can read all enrollments
      allow read: if isAdmin();
      
      // Only admins and teachers can create enrollments
      allow create: if isAdmin() || isTeacher();
      
      // Only admins can update or delete enrollments
      allow update, delete: if isAdmin();
    }
    
    // ==================== GRADES ====================
    match /grades/{gradeId} {
      // Students can read their own grades
      allow read: if isStudent() && 
                    resource.data.studentId == request.auth.uid;
      
      // Teachers can read and write grades for their students
      allow read, write: if isTeacher() && 
                           resource.data.teacherId == request.auth.uid;
      
      // Admins can read all grades
      allow read: if isAdmin();
      
      // Admins can update or delete grades (for corrections)
      allow update, delete: if isAdmin();
    }
    
    // ==================== TEACHER APPLICATIONS ====================
    match /teacher_applications/{applicationId} {
      // Teachers can read their own applications
      allow read: if isTeacher() && 
                    resource.data.teacherId == request.auth.uid;
      
      // Teachers can create applications
      allow create: if isTeacher() && 
                      request.resource.data.teacherId == request.auth.uid;
      
      // Admins can read all applications
      allow read: if isAdmin();
      
      // Admins can update applications (approve/reject)
      allow update: if isAdmin();
      
      // Only admins or the teacher who created it can delete
      allow delete: if isAdmin() || 
                      (isTeacher() && resource.data.teacherId == request.auth.uid);
    }
    
    // ==================== STUDENT APPLICATIONS ====================
    match /student_applications/{applicationId} {
      // Students can read their own applications
      allow read: if isStudent() && 
                    resource.data.studentId == request.auth.uid;
      
      // Students can create applications
      allow create: if isStudent() && 
                      request.resource.data.studentId == request.auth.uid;
      
      // Teachers and admins can read applications
      allow read: if isTeacher() || isAdmin();
      
      // Teachers can update applications (approve/reject) for their subjects
      allow update: if isTeacher() && 
                      resource.data.teacherId == request.auth.uid;
      
      // Admins can update any application
      allow update: if isAdmin();
      
      // Only admins or the student who created it can delete
      allow delete: if isAdmin() || 
                      (isStudent() && resource.data.studentId == request.auth.uid);
    }
    
    // ==================== SECTION ASSIGNMENTS ====================
    match /section_assignments/{assignmentId} {
      // Teachers can read their own assignments
      allow read: if isTeacher() && 
                    resource.data.teacherId == request.auth.uid;
      
      // Students can read section assignments for their subjects
      allow read: if isStudent();
      
      // Admins can read all assignments
      allow read: if isAdmin();
      
      // Only admins can create, update, or delete section assignments
      allow create, update, delete: if isAdmin();
    }
    
    // ==================== ACADEMIC PERIODS ====================
    match /academic_periods/{periodId} {
      // Everyone can read academic periods
      allow read: if isAuthenticated();
      
      // Only admins can manage academic periods
      allow create, update, delete: if isAdmin();
    }
    
    // ==================== ATTENDANCE ====================
    match /attendance/{attendanceId} {
      // Students can read their own attendance
      allow read: if isStudent() && 
                    resource.data.studentId == request.auth.uid;
      
      // Teachers can read and write attendance for their students
      allow read, write: if isTeacher() && 
                           resource.data.teacherId == request.auth.uid;
      
      // Admins can read all attendance
      allow read: if isAdmin();
    }
    
    // ==================== DEFAULT DENY ====================
    // Deny access to all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

