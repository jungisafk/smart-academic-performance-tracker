rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for role-based access
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }
    
    function isTeacher() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'TEACHER';
    }
    
    function isStudent() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'STUDENT';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidGrade(grade) {
      return grade >= 0 && grade <= 100;
    }
    
    function isValidGradePeriod(period) {
      return period in ['PRELIM', 'MIDTERM', 'FINAL'];
    }
    
    function isActiveUser() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.active == true;
    }
    
    
    // Users collection - Role-based access
    match /users/{userId} {
      allow read: if isAuthenticated() && (isAdmin() || isOwner(userId));
      allow create: if isAuthenticated() && isAdmin();
      allow update: if isAuthenticated() && (isAdmin() || isOwner(userId));
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // Subjects collection - Admin, Teacher, and Student read access
    match /subjects/{subjectId} {
      allow read: if isAuthenticated() && (isAdmin() || isTeacher() || isStudent());
      allow create: if isAuthenticated() && isAdmin();
      allow update: if isAuthenticated() && isAdmin();
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // Grades collection - Period-specific access control
    match /grades/{gradeId} {
      allow read: if isAuthenticated() && isActiveUser() && (
        // Students can read their own grades
        (isStudent() && resource.data.studentId == request.auth.uid) ||
        // Teachers can read grades for subjects they teach
        (isTeacher() && get(/databases/$(database)/documents/subjects/$(resource.data.subjectId)).data.teacherId == request.auth.uid) ||
        // Admins can read all grades
        isAdmin()
      );
      
      allow create: if isAuthenticated() && isActiveUser() && (
        // Teachers can create grades for their subjects
        (isTeacher() && request.resource.data.teacherId == request.auth.uid) ||
        // Admins can create any grade
        isAdmin()
      ) && isValidGrade(request.resource.data.score) && 
         isValidGrade(request.resource.data.maxScore) &&
         isValidGradePeriod(request.resource.data.gradePeriod);
      
      allow update: if isAuthenticated() && isActiveUser() && (
        // Teachers can update grades for subjects they teach
        (isTeacher() && get(/databases/$(database)/documents/subjects/$(request.resource.data.subjectId)).data.teacherId == request.auth.uid) ||
        // Admins can update any grade
        isAdmin()
      ) && isValidGrade(request.resource.data.score) && 
         isValidGrade(request.resource.data.maxScore) &&
         isValidGradePeriod(request.resource.data.gradePeriod);
      
      allow delete: if isAuthenticated() && isActiveUser() && (
        // Teachers can delete grades for their subjects
        (isTeacher() && resource.data.teacherId == request.auth.uid) ||
        // Admins can delete any grade
        isAdmin()
      );
    }
    
    // Enrollments collection - Student view, Teacher/Admin write
    match /enrollments/{enrollmentId} {
      allow read: if isAuthenticated() && isActiveUser() && (
        // Students can read their own enrollments
        (isStudent() && resource.data.studentId == request.auth.uid) ||
        // Teachers can read enrollments for subjects they teach
        (isTeacher() && get(/databases/$(database)/documents/subjects/$(resource.data.subjectId)).data.teacherId == request.auth.uid) ||
        // Admins can read all enrollments
        isAdmin()
      );
      
      // Teachers can create/update enrollments for subjects they teach; Admins unrestricted
      allow create: if isAuthenticated() && isActiveUser() && (
        isAdmin() ||
        (isTeacher() && get(/databases/$(database)/documents/subjects/$(request.resource.data.subjectId)).data.teacherId == request.auth.uid)
      );
      allow update: if isAuthenticated() && isActiveUser() && (
        isAdmin() ||
        (isTeacher() && get(/databases/$(database)/documents/subjects/$(request.resource.data.subjectId)).data.teacherId == request.auth.uid)
      );
      allow delete: if isAuthenticated() && isActiveUser() && isAdmin();
    }
    
    // Legacy Student Applications collection (kept for backward compatibility)
    match /student_applications/{applicationId} {
      allow read: if isAuthenticated() && (
        // Students can read their own applications
        (isStudent() && resource.data.studentId == request.auth.uid) ||
        // Teachers can read all applications (for now, to allow subject-based queries)
        isTeacher() ||
        // Admins can read all applications
        isAdmin()
      );
      
      allow create: if isAuthenticated() && isStudent() && 
                   request.resource.data.studentId == request.auth.uid;
      
      allow update: if isAuthenticated() && (
        // Students can update their own applications
        (isStudent() && resource.data.studentId == request.auth.uid) ||
        // Teachers can update applications for their subjects
        isTeacher() ||
        // Admins can update any application
        isAdmin()
      );
      
      allow delete: if isAuthenticated() && (
        // Students can delete their own applications
        (isStudent() && resource.data.studentId == request.auth.uid) ||
        // Admins can delete any application
        isAdmin()
      );
    }

    // Subject Applications collection (current collection used by the app)
    match /subject_applications/{applicationId} {
      allow read: if isAuthenticated() && (
        // Students can read their own applications
        (isStudent() && resource.data.studentId == request.auth.uid) ||
        // Teachers can read applications for subjects they teach
        (isTeacher() && get(/databases/$(database)/documents/subjects/$(resource.data.subjectId)).data.teacherId == request.auth.uid) ||
        // Admins can read all applications
        isAdmin()
      );

      allow create: if isAuthenticated() && isStudent() && 
                   request.resource.data.studentId == request.auth.uid;

      allow update: if isAuthenticated() && (
        // Students can update their own applications (e.g., withdraw)
        (isStudent() && resource.data.studentId == request.auth.uid) ||
        // Teachers can update applications for subjects they teach
        (isTeacher() && get(/databases/$(database)/documents/subjects/$(resource.data.subjectId)).data.teacherId == request.auth.uid) ||
        // Admins can update any application
        isAdmin()
      );

      allow delete: if isAuthenticated() && (
        // Students can delete their own applications
        (isStudent() && resource.data.studentId == request.auth.uid) ||
        // Admins can delete any application
        isAdmin()
      );
    }
    
    // Teacher Applications collection
    match /teacher_applications/{applicationId} {
      allow read: if isAuthenticated() && isActiveUser() && (
        // Teachers can read their own applications
        (isTeacher() && resource.data.teacherId == request.auth.uid) ||
        // Admins can read all applications
        isAdmin()
      );
      
      allow create: if isAuthenticated() && isActiveUser() && isTeacher() && 
                   request.resource.data.teacherId == request.auth.uid;
      
      allow update: if isAuthenticated() && isActiveUser() && (
        // Teachers can update their own applications
        (isTeacher() && resource.data.teacherId == request.auth.uid) ||
        // Admins can update any application
        isAdmin()
      );
      
      allow delete: if isAuthenticated() && isActiveUser() && (
        // Teachers can delete their own applications
        (isTeacher() && resource.data.teacherId == request.auth.uid) ||
        // Admins can delete any application
        isAdmin()
      );
    }
    
    // Courses collection - Admin only
    match /courses/{courseId} {
      allow read: if isAuthenticated() && isActiveUser();
      allow create, update, delete: if isAuthenticated() && isActiveUser() && isAdmin();
    }
    
    // Year Levels collection - Admin only
    match /year_levels/{yearLevelId} {
      allow read: if isAuthenticated() && isActiveUser();
      allow create, update, delete: if isAuthenticated() && isActiveUser() && isAdmin();
    }
    
    // Grade Aggregates collection - allow teacher read for their subject
    match /grade_aggregates/{aggregateId} {
      allow read: if isAuthenticated() && isActiveUser() && (
        (isStudent() && resource.data.studentId == request.auth.uid) ||
        (isTeacher() && get(/databases/$(database)/documents/subjects/$(resource.data.subjectId)).data.teacherId == request.auth.uid) ||
        isAdmin()
      );
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }

    // Academic Periods collection - Admin only
    match /academic_periods/{periodId} {
      allow read: if isAuthenticated() && (isAdmin() || isActiveUser());
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }
    
    // Audit Trails collection - Read-only for most users
    match /audit_trails/{auditId} {
      allow read: if isAuthenticated() && isActiveUser() && (
        // Students can read audit trails for their grades
        (isStudent() && resource.data.studentId == request.auth.uid) ||
        // Teachers can read audit trails for their subjects
        (isTeacher() && resource.data.teacherId == request.auth.uid) ||
        // Admins can read all audit trails
        isAdmin()
      );
      
      // Only system can create audit trails (server-side only)
      allow create: if false;
      allow update, delete: if false;
    }
    
    // System Configuration - Admin only
    match /system_config/{configId} {
      allow read: if isAuthenticated() && isActiveUser();
      allow create, update, delete: if isAuthenticated() && isActiveUser() && isAdmin();
    }
  }
}
